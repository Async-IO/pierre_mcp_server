#!/bin/bash
# ABOUTME: Git pre-push hook - Runs critical path tests before push
# ABOUTME: Prevents pushing code that fails essential tests (5-10 minute run)
#
# SPDX-License-Identifier: MIT OR Apache-2.0
# Copyright (c) 2025 Pierre Fitness Intelligence

set -e

# Get the project root (git hooks run from repo root)
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# Check if this is a delete operation (no validation needed)
# Pre-push hook receives: <local ref> <local sha1> <remote ref> <remote sha1>
# For deletes, local sha1 is all zeros
ZERO_SHA="0000000000000000000000000000000000000000"
IS_DELETE=true

while read -r local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" != "$ZERO_SHA" ]; then
        IS_DELETE=false
        break
    fi
done

if [ "$IS_DELETE" = true ]; then
    echo "üóëÔ∏è  Branch delete operation - skipping validation"
    exit 0
fi

echo ""
echo "üîç Running pre-push validation..."
echo ""

# Get current branch name
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Function to check for in-flight workflows and provide cancel command
check_inflight_workflows() {
    if ! command -v gh &> /dev/null; then
        return 0
    fi

    # Get repository info from git remote
    REMOTE_URL=$(git remote get-url origin 2>/dev/null || echo "")
    if [ -z "$REMOTE_URL" ]; then
        return 0
    fi

    # Extract owner/repo from remote URL (handles both HTTPS and SSH formats)
    REPO_SLUG=$(echo "$REMOTE_URL" | sed -E 's|.*github\.com[:/]([^/]+/[^/.]+)(\.git)?$|\1|')
    if [ -z "$REPO_SLUG" ]; then
        return 0
    fi

    # Find in-progress and queued workflow runs for this branch
    IN_PROGRESS_RUNS=$(gh run list --repo "$REPO_SLUG" --branch "$CURRENT_BRANCH" --status in_progress --json databaseId --jq '.[].databaseId' 2>/dev/null || echo "")
    QUEUED_RUNS=$(gh run list --repo "$REPO_SLUG" --branch "$CURRENT_BRANCH" --status queued --json databaseId --jq '.[].databaseId' 2>/dev/null || echo "")

    ALL_RUNS="$IN_PROGRESS_RUNS $QUEUED_RUNS"
    RUN_COUNT=0
    RUN_IDS=""

    for run_id in $ALL_RUNS; do
        if [ -n "$run_id" ]; then
            RUN_COUNT=$((RUN_COUNT + 1))
            RUN_IDS="$RUN_IDS $run_id"
        fi
    done

    if [ "$RUN_COUNT" -gt 0 ]; then
        echo "‚ö†Ô∏è  Found $RUN_COUNT in-flight workflow(s) on branch '$CURRENT_BRANCH'"
        echo ""
        echo "   After your push succeeds, cancel stale workflows with:"
        echo ""
        for run_id in $RUN_IDS; do
            echo "   gh run cancel $run_id --repo $REPO_SLUG"
        done
        echo ""
        echo "   Or cancel all at once:"
        echo "   for id in$RUN_IDS; do gh run cancel \$id --repo $REPO_SLUG; done"
        echo ""
        # Store for post-push suggestion
        export PENDING_CANCEL_RUNS="$RUN_IDS"
        export PENDING_CANCEL_REPO="$REPO_SLUG"
    fi
}

# Check for CCFW mode (either no gh CLI OR .git/ccfw_mode marker exists)
CCFW_MODE=false
if [ -f "$PROJECT_ROOT/.git/ccfw_mode" ] || ! command -v gh &> /dev/null; then
    CCFW_MODE=true
    echo "‚ö†Ô∏è  =============================================="
    echo "‚ö†Ô∏è  CCFW MODE ACTIVE"
    echo "‚ö†Ô∏è  (Strict validation enabled)"
    echo "‚ö†Ô∏è  =============================================="
    echo ""
    echo "You MUST manually verify CI status before pushing!"
    echo ""
    echo "Use WebFetch to check GitHub Actions status:"
    echo "  URL: https://github.com/Async-IO/pierre_mcp_server/actions"
    echo "  Prompt: 'What is the status of the most recent workflow run on branch $CURRENT_BRANCH?'"
    echo ""
    echo "If CI is currently running or failing, DO NOT push until resolved."
    echo ""

    # CCFW gets strict clippy validation since they can't easily check CI
    echo "üî¨ Running STRICT clippy validation..."
    echo ""
    cd "$PROJECT_ROOT"
    if ! cargo clippy --all-targets --all-features --quiet -- -D warnings -D clippy::all -D clippy::pedantic -D clippy::nursery; then
        echo ""
        echo "‚ùå Strict clippy validation failed!"
        echo ""
        echo "Fix the warnings above before pushing."
        echo "To bypass (NOT RECOMMENDED): git push --no-verify"
        echo ""
        exit 1
    fi
    echo "‚úÖ Strict clippy passed"
    echo ""
fi

# Run architectural validation first (fast, catches pattern violations)
if [ -f "$PROJECT_ROOT/scripts/architectural-validation.sh" ]; then
    echo "üìê Running architectural validation..."
    if ! "$PROJECT_ROOT/scripts/architectural-validation.sh"; then
        echo ""
        echo "‚ùå Architectural validation failed!"
        echo ""
        echo "Fix the violations above before pushing."
        echo "To bypass (NOT RECOMMENDED): git push --no-verify"
        echo ""
        exit 1
    fi
    echo ""
fi

# Check if pre-push tests script exists
if [ ! -f "$PROJECT_ROOT/scripts/pre-push-tests.sh" ]; then
    echo "‚ö†Ô∏è  Warning: pre-push-tests.sh not found, skipping tests"
    echo "   Location: $PROJECT_ROOT/scripts/pre-push-tests.sh"
    check_inflight_workflows
    exit 0
fi

# Run the pre-push tests
cd "$PROJECT_ROOT"

if ./scripts/pre-push-tests.sh; then
    echo ""
    echo "‚úÖ Pre-push validation passed!"
    echo ""

    # Check for in-flight workflows and suggest cancellation AFTER push succeeds
    check_inflight_workflows

    echo "üöÄ Push will proceed. After it succeeds, consider cancelling stale workflows above."
    echo ""
else
    echo ""
    echo "‚ùå Pre-push validation failed!"
    echo ""
    echo "Your push has been blocked to prevent CI failures."
    echo ""
    echo "Options:"
    echo "  1. Fix the failing tests and try again"
    echo "  2. Run specific tests: cargo test --test <test_name>"
    echo "  3. Run full test suite: ./scripts/lint-and-test.sh"
    echo "  4. Skip this check (NOT RECOMMENDED): git push --no-verify"
    echo ""
    exit 1
fi
