#!/bin/bash
# ABOUTME: Git pre-push hook - Runs critical path tests before push
# ABOUTME: Prevents pushing code that fails essential tests (5-10 minute run)
#
# Licensed under either of Apache License, Version 2.0 or MIT License at your option.
# Copyright ¬©2025 Async-IO.org

set -e

# Get the project root (git hooks run from repo root)
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# Check if this is a delete operation (no validation needed)
# Pre-push hook receives: <local ref> <local sha1> <remote ref> <remote sha1>
# For deletes, local sha1 is all zeros
ZERO_SHA="0000000000000000000000000000000000000000"
IS_DELETE=true

while read -r local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" != "$ZERO_SHA" ]; then
        IS_DELETE=false
        break
    fi
done

if [ "$IS_DELETE" = true ]; then
    echo "üóëÔ∏è  Branch delete operation - skipping validation"
    exit 0
fi

echo ""
echo "üîç Running pre-push validation..."
echo ""

# Run architectural validation first (fast, catches pattern violations)
if [ -f "$PROJECT_ROOT/scripts/architectural-validation.sh" ]; then
    echo "üìê Running architectural validation..."
    if ! "$PROJECT_ROOT/scripts/architectural-validation.sh"; then
        echo ""
        echo "‚ùå Architectural validation failed!"
        echo ""
        echo "Fix the violations above before pushing."
        echo "To bypass (NOT RECOMMENDED): git push --no-verify"
        echo ""
        exit 1
    fi
    echo ""
fi

# Validate examples if they were modified
echo "üîç Validating examples compile..."

# Check if examples were modified in the commits being pushed
if git diff --name-only @{upstream}..HEAD 2>/dev/null | grep -q "^examples/"; then
    echo "  Examples modified, running validation..."

    for dir in examples/agents/*/; do
        if [ -f "$dir/Cargo.toml" ]; then
            name=$(basename "$dir")
            echo -n "    Checking $name... "
            if (cd "$dir" && cargo check --quiet 2>/dev/null); then
                echo "OK"
            else
                echo "FAILED"
                echo ""
                echo "‚ùå Example $name failed to compile"
                echo ""
                echo "Fix the compilation errors before pushing."
                echo "To bypass (NOT RECOMMENDED): git push --no-verify"
                echo ""
                exit 1
            fi
        fi
    done

    echo "  ‚úÖ All modified examples compile"
    echo ""
else
    echo "  No examples modified, skipping"
    echo ""
fi

# Check if pre-push tests script exists
if [ ! -f "$PROJECT_ROOT/scripts/pre-push-tests.sh" ]; then
    echo "‚ö†Ô∏è  Warning: pre-push-tests.sh not found, skipping tests"
    echo "   Location: $PROJECT_ROOT/scripts/pre-push-tests.sh"
    exit 0
fi

# Run the pre-push tests
cd "$PROJECT_ROOT"

if ./scripts/pre-push-tests.sh; then
    echo ""
    echo "‚úÖ Pre-push validation passed!"
    echo ""
else
    echo ""
    echo "‚ùå Pre-push validation failed!"
    echo ""
    echo "Your push has been blocked to prevent CI failures."
    echo ""
    echo "Options:"
    echo "  1. Fix the failing tests and try again"
    echo "  2. Run specific tests: cargo test --test <test_name>"
    echo "  3. Run full test suite: ./scripts/lint-and-test.sh"
    echo "  4. Skip this check (NOT RECOMMENDED): git push --no-verify"
    echo ""
    exit 1
fi
